.container.py-4
  %nav{ "aria-label" => "breadcrumb" }
    %ol.breadcrumb.mb-4
      %li.breadcrumb-item= link_to "Countries", countries_path, class: "text-decoration-none"
      - if @country
        %li.breadcrumb-item= link_to @country.name, country_competitions_path(@country), class: "text-decoration-none"
      - if @competition
        %li.breadcrumb-item= link_to @competition.name, country_competition_events_path(@country, @competition), class: "text-decoration-none"
      %li.breadcrumb-item.active= @event.name

  %header.mb-4
    .d-flex.justify-content-between.align-items-center
      %div
        .d-flex.align-items-center.mb-2
          - if @event.predictions.present?
            %img.me-2{ src: @event.predictions.dig('teams', 'home', 'logo'), width: '40', height: '40', alt: 'Home Badge' }
            %h1.h3.mb-0.mx-2 VS
            %img.ms-2{ src: @event.predictions.dig('teams', 'away', 'logo'), width: '40', height: '40', alt: 'Away Badge' }
          - else
            %h1.h3.mb-0= @event.name
        
        %div.text-muted
          - kickoff = @event.kick_off&.in_time_zone || @event.kick_off
          - if kickoff
            %span.me-3
              %strong Kick Off:
              = kickoff.strftime("%a %d %b %H:%M %Z")
          - if @competition
            %span.me-3
              %strong Competition:
              = @competition.name

      - if @event.predictions.present?
        .text-end
          .badge.bg-primary.p-2.shadow-sm
            %i.bi.bi-cpu-fill.me-1
            AI Advice:
            = @event.predictions.dig('predictions', 'advice')

  - if @event.predictions.present?
    - pred = @event.predictions
    - home = pred.dig('teams', 'home')
    - away = pred.dig('teams', 'away')
    - comp = pred['comparison']

    -# --- SECTION 1: PROBABILITY & COMPARISON ---
    .row.mb-4
      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small AI Win Probability
          .card-body
            - perc = pred.dig('predictions', 'percent')
            .d-flex.justify-content-between.mb-1.small
              %span= home['name']
              %span= perc['home']
            .progress.mb-3{ style: "height: 12px; border-radius: 10px;" }
              .progress-bar.bg-success{ style: "width: #{perc['home']}" }
              .progress-bar.bg-secondary{ style: "width: #{perc['draw']}" }
              .progress-bar.bg-info{ style: "width: #{perc['away']}" }
            .d-flex.justify-content-between.small.text-muted
              %span Draw: #{perc['draw']}
              %span= "#{away['name']}: #{perc['away']}"

      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small Statistical Advantage
          .card-body.py-2
            - ['att', 'def', 'poisson_distribution', 'h2h'].each do |attr|
              .mb-2
                .d-flex.justify-content-between.very-small.text-uppercase.fw-bold{ style: "font-size: 0.65rem;" }
                  %span= attr.humanize
                .progress{ style: "height: 6px; background-color: #f0f0f0;" }
                  .progress-bar.bg-primary{ style: "width: #{comp.dig(attr, 'home')}" }
                  .progress-bar.bg-info.opacity-50{ style: "width: #{comp.dig(attr, 'away')}" }

      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small Head to Head History
          .card-body.p-0
            %ul.list-group.list-group-flush.small
              - pred['h2h'].first(5).each do |game|
                %li.list-group-item.py-1.d-flex.justify-content-between
                  %span.text-muted= game.dig('fixture', 'date').to_date.strftime('%b %y')
                  %span.fw-bold
                    = "#{game.dig('goals', 'home')} - #{game.dig('goals', 'away')}"
                  %span.text-muted.very-small= game.dig('league', 'name')

    -# --- SECTION 2: TEAM FORM MOMENTUM ---
    .row.mb-4
      - [home, away].each_with_index do |team, idx|
        .col-md-6
          .card.shadow-sm
            .card-header.bg-white.d-flex.justify-content-between.align-items-center
              %div
                %img.me-2{ src: team['logo'], width: '20' }
                %strong= team['name']
              .small
                %span.text-muted Last 5:
                - team.dig('league', 'form').to_s.last(5).chars.each do |c|
                  - color = c == 'W' ? 'text-success' : (c == 'L' ? 'text-danger' : 'text-warning')
                  %span{ class: "fw-bold #{color}" }= c
            .card-body.py-2
              .row.text-center
                .col-4
                  .small.text-muted Attacking
                  .h5.mb-0= team.dig('last_5', 'att')
                .col-4.border-start.border-end
                  .small.text-muted Defensive
                  .h5.mb-0= team.dig('last_5', 'def')
                .col-4
                  .small.text-muted Form
                  .h5.mb-0= team.dig('last_5', 'form')

    -# --- SECTION 3: GOAL TIMING & DISCIPLINE ---
    .row.mb-4
      .col-md-8
        .card.shadow-sm
          .card-header.bg-light.fw-bold.small Scoring Patterns (Goals For %)
          .card-body
            .table-responsive
              %table.table.table-borderless.table-sm.mb-0.text-center{ style: "font-size: 0.75rem;" }
                %thead.text-muted.text-uppercase
                  %tr
                    %th Team
                    - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                      %th= min
                %tbody
                  - [home, away].each do |team|
                    %tr
                      %td.text-start.fw-bold= team['name']
                      - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                        - val = team.dig('league', 'goals', 'for', 'minute', min, 'percentage')
                        %td
                          .p-1.rounded{ class: val.to_f > 25 ? 'bg-success text-white' : 'bg-light' }
                            = val || '0%'
      .col-md-4
        .card.shadow-sm
          .card-header.bg-light.fw-bold.small Tactical & Discipline
          .card-body.py-2
            .d-flex.justify-content-between.small.mb-2
              %span.text-muted Preferred Setup:
              %span.fw-bold= "#{home.dig('league', 'lineups', 0, 'formation')} vs #{away.dig('league', 'lineups', 0, 'formation')}"
            .d-flex.justify-content-between.small.mb-2
              %span.text-muted Clean Sheets:
              %span.fw-bold= "#{home.dig('league', 'clean_sheet', 'total')} - #{away.dig('league', 'clean_sheet', 'total')}"
            %hr.my-2
            .very-small.text-uppercase.text-muted.mb-1 Most Dangerous Discipline Period
            - [home, away].each do |team|
              - dangerous_card_period = team.dig('league', 'cards', 'yellow').max_by { |k, v| v['percentage'].to_f }
              .d-flex.justify-content-between.very-small.mb-1
                %span= team['name']
                %span.text-danger= "#{dangerous_card_period&.first} min (#{dangerous_card_period&.last&.dig('percentage')})"

  -# --- EXISTING BETFAIR MARKETS ---
  - if @markets.present?
    .row
      .col-12
        - @markets.each do |market|
          .card.mb-4.shadow-sm.border-0
            .card-header.bg-white.border-bottom.d-flex.justify-content-between.align-items-center.py-3
              %div
                %h2.h5.mb-0.fw-bold= market.name
                %small.text-muted.font-monospace= "ID: #{market.betfair_market_id}"
              %div.text-end
                - if market.inplay?
                  %span.badge.bg-danger.me-2.animate-pulse LIVE
                - if market.status.present?
                  %span.badge.bg-light.text-dark.border= market.status

            .card-body.p-0
              - if market.competitors.any?
                .table-responsive
                  %table.table.table-hover.align-middle.mb-0
                    %thead.table-light.text-muted.small.text-uppercase
                      %tr
                        %th.ps-4 Competitor
                        %th.text-center Last Price
                        %th.text-center Liquidity & Spread
                        %th.text-end Implied Prob
                        %th.text-end.pe-4 History
                    %tbody
                      - market.competitors.each do |competitor|
                        - price = competitor.latest_price
                        - history = competitor.recent_prices
                        - ex_data = competitor.exchange_data || {}
                        - spread = ex_data['spread'].to_f
                        - volume = ex_data['total_matched'].to_f
                        - last_traded = ex_data['last_price_traded']

                        -# Spread Color Logic: Tight spreads (< 0.10) are Green (Good). Wide spreads are Red.
                        - spread_color = spread > 0.5 ? 'bg-danger bg-opacity-10 text-danger' : (spread > 0.1 ? 'bg-warning bg-opacity-10 text-dark' : 'bg-success bg-opacity-10 text-success')
                        - spread_color = 'bg-light text-muted' if spread.zero? && volume.zero?

                        %tr
                          %td.ps-4.fw-bold= competitor.name
                          
                          -# Column: Last Traded Price
                          %td.text-center
                            - if last_traded
                              %span.font-monospace.fw-bold.fs-6= last_traded
                            - else
                              %span.text-muted -

                          -# Column: Liquidity & Spread
                          %td.text-center
                            .d-flex.flex-column.align-items-center
                              -# Volume
                              %span.small.fw-bold.mb-1
                                = number_to_currency(volume, unit: "£", precision: 0)
                              
                              -# Spread Badge
                              - if spread > 0
                                %span.badge.rounded-pill.border{ class: spread_color }
                                  Spread: #{spread}
                              - else
                                %span.badge.bg-light.text-muted.border Low Liq
                          
                          -# Column: Implied Probability (from your calculator)
                          %td.text-end
                            - if price&.percentage
                              %span.fs-6= "#{price.percentage.to_f.round(1)}%"
                            - else
                              %span.text-muted --

                          -# Column: Price History
                          %td.text-end.pe-4
                            - if history.any?
                              .d-flex.flex-wrap.justify-content-end.gap-1
                                - history.first(3).each do |historic_price|
                                  %span.badge.bg-light.text-secondary.border
                                    = "#{historic_price.percentage.to_f.round(1)}%"
                            - else
                              %span.text-muted.small No Data
  - else
    .alert.alert-info.d-flex.align-items-center
      %i.bi.bi-info-circle-fill.me-2
      No markets have been captured for this event yet.

  -# --- SECTION 4: EXCHANGE LIQUIDITY ---
  - if @event.exchange_data.present?
    .card.mb-4.shadow-sm.border-success.border-opacity-25
      .card-header.bg-success.bg-opacity-10.d-flex.justify-content-between.align-items-center
        %div
          %i.bi.bi-currency-exchange.text-success.me-2
          %span.fw-bold.text-success Exchange Activity
        %div.small.text-muted
          - if @event.exchange_data['last_synced_at']
            %i.bi.bi-clock-history.me-1
            Updated
            = time_ago_in_words(@event.exchange_data['last_synced_at'])
            ago

      .card-body.py-3
        .row.align-items-center.text-center
          -# Column 1: Total Traded Volume
          .col-md-6.border-end
            .d-flex.flex-column
              %span.text-uppercase.text-muted.small.fw-bold Total Traded
              %span.display-6.fw-bold.text-dark
                -# Formatting: £12,345 (No decimals for volume usually looks cleaner)
                = number_to_currency(@event.exchange_data['total_matched'], unit: "£", precision: 0)
              %span.small.text-muted Matches actual bets placed

          -# Column 2: Available Liquidity
          .col-md-6
            .d-flex.flex-column
              %span.text-uppercase.text-muted.small.fw-bold Waiting Liquidity
              %span.display-6.fw-bold.text-success
                = number_to_currency(@event.exchange_data['total_available'], unit: "£", precision: 0)
              %span.small.text-muted Money waiting to be matched

          -# Optional: Visual Progress Bar representing "Heat"
          - matched = @event.exchange_data['total_matched'].to_f
          - available = @event.exchange_data['total_available'].to_f
          - total = matched + available
          - if total > 0
            .col-12.mt-3
              .progress{ style: "height: 8px;" }
                .progress-bar.bg-dark{ style: "width: #{(matched / total) * 100}%", title: "Matched" }
                .progress-bar.bg-success{ style: "width: #{(available / total) * 100}%", title: "Available" }

  %details.mt-5
    %summary.text-muted.small View Raw Data
    %pre.bg-light.p-3.rounded
      %code= JSON.pretty_generate(@event.predictions)