- content_for :title, @event.name

- pred = @event.predictions
- home = @event.predicted_home_team
- away = @event.predicted_away_team
- home_name = @event.home_team_name
- away_name = @event.away_team_name
- home_logo = @event.home_team_logo
- away_logo = @event.away_team_logo
- comp = pred&.dig('comparison')
- perc = pred&.dig('predictions', 'percent')
- kickoff = @event.kick_off&.in_time_zone || @event.kick_off
- primary_market = @event.primary_market
- markets_count = @markets&.size || 0
- event_tags = @event.tags
- breadcrumb_items = [{ label: 'Countries', path: countries_path }]
- if @country
  - breadcrumb_items << { label: @country.name, path: country_competitions_path(@country) }
- if @competition
  - comp_path = @country ? country_competition_events_path(@country, @competition) : nil
  - breadcrumb_items << { label: @competition.name, path: comp_path }
- breadcrumb_items << { label: @event.name }

.page-shell.pb-5
  .container
    = render 'shared/breadcrumbs', items: breadcrumb_items

    %section.page-hero.mb-5
      .row.align-items-center.gy-4
        .col-lg-7
          %p.hero-kicker= @country&.name || 'Event Insight'
          - if home_name && away_name
            .matchup-stack.mb-4
              .text-center
                - if home_logo.present?
                  %img{ src: home_logo, width: 72, height: 72, alt: "#{home_name} badge" }
                %p.small.text-white-50.mb-0= home_name
              %span.vs-pill VS
              .text-center
                - if away_logo.present?
                  %img{ src: away_logo, width: 72, height: 72, alt: "#{away_name} badge" }
                %p.small.text-white-50.mb-0= away_name
            %h1.display-5.fw-bold.mb-3= "#{home_name} vs #{away_name}"
          - else
            %h1.display-5.fw-bold.mb-3= @event.name
          %p.lead.text-white-50.mb-4 Track AI probabilities, liquidity, and exchange movement before this fixture goes off.
          .hero-meta
            .meta-item
              %span Kickoff
              %strong= kickoff ? kickoff.strftime('%a %d %b · %H:%M %Z') : 'TBD'
            .meta-item
              %span Competition
              %strong= @competition&.name || 'Awaiting assignment'
            .meta-item
              %span Markets synced
              %strong= markets_count
            - if primary_market&.status.present?
              .meta-item
                %span Primary market
                %strong= primary_market.status.titleize
          - if event_tags.any?
            .mt-4
              %span.eyebrow.text-white-50 Event Tags
              .d-flex.flex-wrap.gap-2.mt-2
                - event_tags.each do |tag|
                  %span{ class: "badge rounded-pill #{tag_badge_class(tag)}", title: tag_category_label(tag) }
                    = tag.name
        .col-lg-5
          .glass-panel
            %span.eyebrow.text-white-50 Market Signal
            - if pred.present?
              %h3.h5.text-white.fw-semibold.mb-3= pred.dig('predictions', 'advice') || 'Edge snapshot'
              %p.text-white-50.mb-3 Model confidence split
              .d-flex.flex-column.gap-2
                %div.d-flex.justify-content-between.text-white-50
                  %span= home_name || 'Home'
                  %strong.text-white= perc&.dig('home') || '--'
                %div.d-flex.justify-content-between.text-white-50
                  %span Draw
                  %strong.text-white= perc&.dig('draw') || '--'
                %div.d-flex.justify-content-between.text-white-50
                  %span= away_name || 'Away'
                  %strong.text-white= perc&.dig('away') || '--'
            - else
              %h3.h5.text-white.fw-semibold.mb-2 Market intel in progress
              %p.text-white-50.mb-3 Edge projections are syncing for this event. Check back shortly for AI probabilities.
            .d-flex.flex-wrap.gap-2.mt-3
              - if primary_market&.inplay?
                %span.badge.bg-danger.text-white LIVE market
              - if primary_market&.last_synced_label.present?
                %span.badge.bg-light.text-dark= "Updated #{time_ago_in_words(primary_market.last_synced_label)} ago"
              %span.badge.bg-dark.text-white= "#{markets_count} markets"
            - if primary_market&.status.present?
              %span.badge.bg-success.bg-opacity-25.text-white= primary_market.status.titleize

    %section.page-section.pt-0
      - if event_tags.any?
        .row.mb-4
          .col-lg-12
            .surface-card.h-100
              %span.eyebrow.text-primary.mb-2 Event Sentiment
              %h3.h5.fw-bold.mb-2 Media tone for related tags
              %p.text-muted.small.mb-3 Averaged from per-entity article tagging pulled by the EntityExtractor.
              .d-flex.flex-column.gap-3
                - event_tags.each do |tag|
                  = render 'events/tag_sentiment', tag: tag, sentiment_snapshot: @tag_sentiments[tag.id]

      - if @related_articles.any?
        .row.mb-4
          .col-lg-12
            .surface-card.h-100
              %span.eyebrow.text-primary.mb-2 Related Coverage
              %h3.h5.fw-bold.mb-2 Stories mentioning this event's tags
              %p.text-muted.small.mb-3 Latest articles pulled from connected feeds that match this fixture's tags.
              .list-group.list-group-flush
                - @related_articles.each do |article|
                  - article_time = article.published_at || article.created_at
                  %a.list-group-item.list-group-item-action.d-flex.justify-content-between.align-items-start.gap-3{ href: article.url, target: '_blank', rel: 'noopener' }
                    .flex-grow-1
                      %p.fw-semibold.mb-1= article.title
                      - if article.content.present?
                        %p.text-muted.small.mb-0= truncate(strip_tags(article.content), length: 140)
                    .text-end.small.text-muted
                      %div.fw-semibold= article.feed_source&.name || 'External source'
                      - if article_time.present?
                        %div= "#{time_ago_in_words(article_time)} ago"
                      - else
                        %div Date unavailable

      .row.mb-4
        .col-lg-12
          .surface-card.h-100
            %span.eyebrow.text-primary.mb-2 Market Pulse
            %h3.h5.fw-bold.mb-2 Market-implied probabilities
            %p.text-muted.small.mb-3
              Sourced from the latest Betfair market snapshot, refreshed whenever Stat Machine syncs this event.
            = render 'events/market_probabilities',
              market: primary_market,
              event: @event,
              progress_class: 'mt-3',
              show_labels: true,
              empty_message: 'No Betfair probabilities synced yet.'

    %section.page-section.event-dashboard.pt-0
      - if pred.present?
        -# --- SECTION 1: PROBABILITY & COMPARISON ---
        .row.mb-4
          .col-md-4
            .card.h-100.shadow-sm
              .card-header.bg-light.fw-bold.small AI Win Probability
              .card-body
                - perc_values = perc || {}
                - home_pct = perc_values['home'] || '0%'
                - draw_pct = perc_values['draw'] || '0%'
                - away_pct = perc_values['away'] || '0%'
                .d-flex.justify-content-between.mb-1.small
                  %span= home['name']
                  %span= home_pct
                .progress.mb-3{ style: "height: 12px; border-radius: 10px;" }
                  .progress-bar.bg-success{ style: "width: #{home_pct}" }
                  .progress-bar.bg-secondary{ style: "width: #{draw_pct}" }
                  .progress-bar.bg-info{ style: "width: #{away_pct}" }
                .d-flex.justify-content-between.small.text-muted
                  %span Draw: #{draw_pct}
                  %span= "#{away['name']}: #{away_pct}"

          .col-md-4
            .card.h-100.shadow-sm
              .card-header.bg-light.fw-bold.small Statistical Advantage
              .card-body.py-2
                - ['att', 'def', 'poisson_distribution', 'h2h'].each do |attr|
                  .mb-2
                    .d-flex.justify-content-between.very-small.text-uppercase.fw-bold{ style: "font-size: 0.65rem;" }
                      %span= attr.humanize
                    .progress{ style: "height: 6px; background-color: #f0f0f0;" }
                      .progress-bar.bg-primary{ style: "width: #{comp.dig(attr, 'home')}" }
                      .progress-bar.bg-info.opacity-50{ style: "width: #{comp.dig(attr, 'away')}" }

          .col-md-4
            .card.h-100.shadow-sm
              .card-header.bg-light.fw-bold.small Head to Head History
              .card-body.p-0
                %ul.list-group.list-group-flush.small
                  - pred['h2h'].first(5).each do |game|
                    %li.list-group-item.py-1.d-flex.justify-content-between
                      %span.text-muted= game.dig('fixture', 'date').to_date.strftime('%b %y')
                      %span.fw-bold
                        = "#{game.dig('goals', 'home')} - #{game.dig('goals', 'away')}"
                      %span.text-muted.very-small= game.dig('league', 'name')

        -# --- SECTION 2: TEAM FORM MOMENTUM ---
        .row.mb-4
          - [home, away].each_with_index do |team, idx|
            .col-md-6
              .card.shadow-sm
                .card-header.bg-white.d-flex.justify-content-between.align-items-center
                  %div
                    %img.me-2{ src: team['logo'], width: '20' }
                    %strong= team['name']
                  .small
                    %span.text-muted Last 5:
                    - team.dig('league', 'form').to_s.last(5).chars.each do |c|
                      - color = c == 'W' ? 'text-success' : (c == 'L' ? 'text-danger' : 'text-warning')
                      %span{ class: "fw-bold #{color}" }= c
                .card-body.py-2
                  .row.text-center
                    .col-4
                      .small.text-muted Attacking
                      .h5.mb-0= team.dig('last_5', 'att')
                    .col-4.border-start.border-end
                      .small.text-muted Defensive
                      .h5.mb-0= team.dig('last_5', 'def')
                    .col-4
                      .small.text-muted Form
                      .h5.mb-0= team.dig('last_5', 'form')

        -# --- SECTION 3: GOAL TIMING & DISCIPLINE ---
        .row.mb-4
          .col-md-8
            .card.shadow-sm
              .card-header.bg-light.fw-bold.small Scoring Patterns (Goals For %)
              .card-body
                .table-responsive
                  %table.table.table-borderless.table-sm.mb-0.text-center{ style: "font-size: 0.75rem;" }
                    %thead.text-muted.text-uppercase
                      %tr
                        %th Team
                        - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                          %th= min
                    %tbody
                      - [home, away].each do |team|
                        %tr
                          %td.text-start.fw-bold= team['name']
                          - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                            - val = team.dig('league', 'goals', 'for', 'minute', min, 'percentage')
                            %td
                              .p-1.rounded{ class: val.to_f > 25 ? 'bg-success text-white' : 'bg-light' }
                                = val || '0%'
          .col-md-4
            .card.shadow-sm
              .card-header.bg-light.fw-bold.small Tactical & Discipline
              .card-body.py-2
                .d-flex.justify-content-between.small.mb-2
                  %span.text-muted Preferred Setup:
                  %span.fw-bold= "#{home.dig('league', 'lineups', 0, 'formation')} vs #{away.dig('league', 'lineups', 0, 'formation')}"
                .d-flex.justify-content-between.small.mb-2
                  %span.text-muted Clean Sheets:
                  %span.fw-bold= "#{home.dig('league', 'clean_sheet', 'total')} - #{away.dig('league', 'clean_sheet', 'total')}"
                %hr.my-2
                .very-small.text-uppercase.text-muted.mb-1 Most Dangerous Discipline Period
                - [home, away].each do |team|
                  - dangerous_card_period = team.dig('league', 'cards', 'yellow').max_by { |k, v| v['percentage'].to_f }
                  .d-flex.justify-content-between.very-small.mb-1
                    %span= team['name']
                    %span.text-danger= "#{dangerous_card_period&.first} min (#{dangerous_card_period&.last&.dig('percentage')})"
      - else
        .empty-state.mb-4
          %p.mb-2.text-muted AI predictions are syncing for this event.
          %p.text-muted.mb-0 Check back shortly for win probabilities, team form, and matchup insights.

      -# --- EXISTING BETFAIR MARKETS ---
      - if @markets.present?
        .row
          .col-12
            - @markets.each do |market|
              .card.mb-4.shadow-sm.border-0
                .card-header.bg-white.border-bottom.d-flex.justify-content-between.align-items-center.py-3
                  %div
                    %h2.h5.mb-0.fw-bold= market.name
                    %small.text-muted.font-monospace= "ID: #{market.betfair_market_id}"
                  %div.text-end
                    - if market.inplay?
                      %span.badge.bg-danger.me-2.animate-pulse LIVE
                    - if market.status.present?
                      %span.badge.bg-light.text-dark.border= market.status

                .card-body.p-0
                  - if market.competitors.any?
                    .table-responsive
                      %table.table.table-hover.align-middle.mb-0
                        %thead.table-light.text-muted.small.text-uppercase
                          %tr
                            %th.ps-4 Competitor
                            %th.text-center Last Price
                            %th.text-center Liquidity & Spread
                            %th.text-end Implied Prob
                            %th.text-end.pe-4 History
                        %tbody
                          - market.competitors.each do |competitor|
                            - price = competitor.latest_price
                            - history = competitor.recent_prices
                            - ex_data = competitor.exchange_data || {}
                            - spread = ex_data['spread'].to_f
                            - volume = ex_data['total_matched'].to_f
                            - last_traded = ex_data['last_price_traded']

                            -# Spread Color Logic: Tight spreads (< 0.10) are Green (Good). Wide spreads are Red.
                            - spread_color = spread > 0.5 ? 'bg-danger bg-opacity-10 text-danger' : (spread > 0.1 ? 'bg-warning bg-opacity-10 text-dark' : 'bg-success bg-opacity-10 text-success')
                            - spread_color = 'bg-light text-muted' if spread.zero? && volume.zero?

                            %tr
                              %td.ps-4.fw-bold
                                %div= competitor.name
                                - if competitor.tags.any?
                                  .d-flex.flex-wrap.gap-1.mt-2
                                    - competitor.tags.each do |tag|
                                      %span.small{ class: "badge rounded-pill #{tag_badge_class(tag)}", title: tag_category_label(tag) }
                                        = tag.name
                              
                              -# Column: Last Traded Price
                              %td.text-center
                                - if last_traded
                                  %span.font-monospace.fw-bold.fs-6= last_traded
                                - else
                                  %span.text-muted -

                              -# Column: Liquidity & Spread
                              %td.text-center
                                .d-flex.flex-column.align-items-center
                                  -# Volume
                                  %span.small.fw-bold.mb-1
                                    = number_to_currency(volume, unit: "£", precision: 0)
                                  
                                  -# Spread Badge
                                  - if spread > 0
                                    %span.badge.rounded-pill.border{ class: spread_color }
                                      Spread: #{spread}
                                  - else
                                    %span.badge.bg-light.text-muted.border Low Liq
                              
                              -# Column: Implied Probability (from your calculator)
                              %td.text-end
                                - if price&.percentage
                                  %span.fs-6= "#{price.percentage.to_f.round(1)}%"
                                - else
                                  %span.text-muted --

                              -# Column: Price History
                              %td.text-end.pe-4
                                - if history.any?
                                  .d-flex.flex-wrap.justify-content-end.gap-1
                                    - history.first(3).each do |historic_price|
                                      %span.badge.bg-light.text-secondary.border
                                        = "#{historic_price.percentage.to_f.round(1)}%"
                                - else
                                  %span.text-muted.small No Data
      - else
        .empty-state.mb-4
          %p.text-muted.mb-2 No markets have been captured for this event yet.
          %p.text-muted.mb-0 Try syncing from Betfair again to populate market depth.

      -# --- SECTION 4: EXCHANGE LIQUIDITY ---
      - if @event.exchange_data.present?
        .card.mb-4.shadow-sm.border-success.border-opacity-25
          .card-header.bg-success.bg-opacity-10.d-flex.justify-content-between.align-items-center
            %div
              %i.bi.bi-currency-exchange.text-success.me-2
              %span.fw-bold.text-success Exchange Activity
            %div.small.text-muted
              - if @event.exchange_data['last_synced_at']
                %i.bi.bi-clock-history.me-1
                Updated
                = time_ago_in_words(@event.exchange_data['last_synced_at'])
                ago

          .card-body.py-3
            .row.align-items-center.text-center
              -# Column 1: Total Traded Volume
              .col-md-6.border-end
                .d-flex.flex-column
                  %span.text-uppercase.text-muted.small.fw-bold Total Traded
                  %span.display-6.fw-bold.text-dark
                    -# Formatting: £12,345 (No decimals for volume usually looks cleaner)
                    = number_to_currency(@event.exchange_data['total_matched'], unit: "£", precision: 0)
                  %span.small.text-muted Matches actual bets placed

              -# Column 2: Available Liquidity
              .col-md-6
                .d-flex.flex-column
                  %span.text-uppercase.text-muted.small.fw-bold Waiting Liquidity
                  %span.display-6.fw-bold.text-success
                    = number_to_currency(@event.exchange_data['total_available'], unit: "£", precision: 0)
                  %span.small.text-muted Money waiting to be matched

              -# Optional: Visual Progress Bar representing "Heat"
              - matched = @event.exchange_data['total_matched'].to_f
              - available = @event.exchange_data['total_available'].to_f
              - total = matched + available
              - if total > 0
                .col-12.mt-3
                  .progress{ style: "height: 8px;" }
                    .progress-bar.bg-dark{ style: "width: #{(matched / total) * 100}%", title: "Matched" }
                    .progress-bar.bg-success{ style: "width: #{(available / total) * 100}%", title: "Available" }

      %details.mt-5
        %summary.text-muted.small View Raw Data
        %pre.bg-light.p-3.rounded
          %code= JSON.pretty_generate(@event.predictions)
