.container.py-4
  %nav{ "aria-label" => "breadcrumb" }
    %ol.breadcrumb.mb-4
      %li.breadcrumb-item= link_to "Countries", countries_path, class: "text-decoration-none"
      - if @country
        %li.breadcrumb-item= link_to @country.name, country_competitions_path(@country), class: "text-decoration-none"
      - if @competition
        %li.breadcrumb-item= link_to @competition.name, country_competition_events_path(@country, @competition), class: "text-decoration-none"
      %li.breadcrumb-item.active= @event.name

  %header.mb-4
    .d-flex.justify-content-between.align-items-center
      %div
        .d-flex.align-items-center.mb-2
          - if @event.predictions.present?
            %img.me-2{ src: @event.predictions.dig('teams', 'home', 'logo'), width: '40', height: '40', alt: 'Home Badge' }
            %h1.h3.mb-0.mx-2 VS
            %img.ms-2{ src: @event.predictions.dig('teams', 'away', 'logo'), width: '40', height: '40', alt: 'Away Badge' }
          - else
            %h1.h3.mb-0= @event.name
        
        %div.text-muted
          - kickoff = @event.kick_off&.in_time_zone || @event.kick_off
          - if kickoff
            %span.me-3
              %strong Kick Off:
              = kickoff.strftime("%a %d %b %H:%M %Z")
          - if @competition
            %span.me-3
              %strong Competition:
              = @competition.name

      - if @event.predictions.present?
        .text-end
          .badge.bg-primary.p-2.shadow-sm
            %i.bi.bi-cpu-fill.me-1
            AI Advice:
            = @event.predictions.dig('predictions', 'advice')

  - if @event.predictions.present?
    - pred = @event.predictions
    - home = pred.dig('teams', 'home')
    - away = pred.dig('teams', 'away')
    - comp = pred['comparison']

    -# --- SECTION 1: PROBABILITY & COMPARISON ---
    .row.mb-4
      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small AI Win Probability
          .card-body
            - perc = pred.dig('predictions', 'percent')
            .d-flex.justify-content-between.mb-1.small
              %span= home['name']
              %span= perc['home']
            .progress.mb-3{ style: "height: 12px; border-radius: 10px;" }
              .progress-bar.bg-success{ style: "width: #{perc['home']}" }
              .progress-bar.bg-secondary{ style: "width: #{perc['draw']}" }
              .progress-bar.bg-info{ style: "width: #{perc['away']}" }
            .d-flex.justify-content-between.small.text-muted
              %span Draw: #{perc['draw']}
              %span= "#{away['name']}: #{perc['away']}"

      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small Statistical Advantage
          .card-body.py-2
            - ['att', 'def', 'poisson_distribution', 'h2h'].each do |attr|
              .mb-2
                .d-flex.justify-content-between.very-small.text-uppercase.fw-bold{ style: "font-size: 0.65rem;" }
                  %span= attr.humanize
                .progress{ style: "height: 6px; background-color: #f0f0f0;" }
                  .progress-bar.bg-primary{ style: "width: #{comp.dig(attr, 'home')}" }
                  .progress-bar.bg-info.opacity-50{ style: "width: #{comp.dig(attr, 'away')}" }

      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small Head to Head History
          .card-body.p-0
            %ul.list-group.list-group-flush.small
              - pred['h2h'].first(5).each do |game|
                %li.list-group-item.py-1.d-flex.justify-content-between
                  %span.text-muted= game.dig('fixture', 'date').to_date.strftime('%b %y')
                  %span.fw-bold
                    = "#{game.dig('goals', 'home')} - #{game.dig('goals', 'away')}"
                  %span.text-muted.very-small= game.dig('league', 'name')

    -# --- SECTION 2: TEAM FORM MOMENTUM ---
    .row.mb-4
      - [home, away].each_with_index do |team, idx|
        .col-md-6
          .card.shadow-sm
            .card-header.bg-white.d-flex.justify-content-between.align-items-center
              %div
                %img.me-2{ src: team['logo'], width: '20' }
                %strong= team['name']
              .small
                %span.text-muted Last 5:
                - team.dig('league', 'form').to_s.last(5).chars.each do |c|
                  - color = c == 'W' ? 'text-success' : (c == 'L' ? 'text-danger' : 'text-warning')
                  %span{ class: "fw-bold #{color}" }= c
            .card-body.py-2
              .row.text-center
                .col-4
                  .small.text-muted Attacking
                  .h5.mb-0= team.dig('last_5', 'att')
                .col-4.border-start.border-end
                  .small.text-muted Defensive
                  .h5.mb-0= team.dig('last_5', 'def')
                .col-4
                  .small.text-muted Form
                  .h5.mb-0= team.dig('last_5', 'form')

    -# --- SECTION 3: GOAL TIMING & DISCIPLINE ---
    .row.mb-4
      .col-md-8
        .card.shadow-sm
          .card-header.bg-light.fw-bold.small Scoring Patterns (Goals For %)
          .card-body
            .table-responsive
              %table.table.table-borderless.table-sm.mb-0.text-center{ style: "font-size: 0.75rem;" }
                %thead.text-muted.text-uppercase
                  %tr
                    %th Team
                    - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                      %th= min
                %tbody
                  - [home, away].each do |team|
                    %tr
                      %td.text-start.fw-bold= team['name']
                      - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                        - val = team.dig('league', 'goals', 'for', 'minute', min, 'percentage')
                        %td
                          .p-1.rounded{ class: val.to_f > 25 ? 'bg-success text-white' : 'bg-light' }
                            = val || '0%'
      .col-md-4
        .card.shadow-sm
          .card-header.bg-light.fw-bold.small Tactical & Discipline
          .card-body.py-2
            .d-flex.justify-content-between.small.mb-2
              %span.text-muted Preferred Setup:
              %span.fw-bold= "#{home.dig('league', 'lineups', 0, 'formation')} vs #{away.dig('league', 'lineups', 0, 'formation')}"
            .d-flex.justify-content-between.small.mb-2
              %span.text-muted Clean Sheets:
              %span.fw-bold= "#{home.dig('league', 'clean_sheet', 'total')} - #{away.dig('league', 'clean_sheet', 'total')}"
            %hr.my-2
            .very-small.text-uppercase.text-muted.mb-1 Most Dangerous Discipline Period
            - [home, away].each do |team|
              - dangerous_card_period = team.dig('league', 'cards', 'yellow').max_by { |k, v| v['percentage'].to_f }
              .d-flex.justify-content-between.very-small.mb-1
                %span= team['name']
                %span.text-danger= "#{dangerous_card_period&.first} min (#{dangerous_card_period&.last&.dig('percentage')})"

  -# --- EXISTING BETFAIR MARKETS ---
  - if @markets.present?
    .row
      .col-12
        - @markets.each do |market|
          .card.mb-4.shadow-sm
            .card-header.d-flex.justify-content-between.align-items-center
              %div
                %h2.h5.mb-0= market.name
                %small.text-muted= "Betfair Market ID: #{market.betfair_market_id}"
              %div.text-end
                - if market.inplay?
                  %span.badge.bg-danger.me-2 LIVE
                - if market.status.present?
                  %span.badge.bg-secondary= market.status
            .card-body
              - if market.competitors.any?
                %table.table.table-sm.align-middle.mb-0
                  %thead
                    %tr
                      %th Competitor
                      %th.text-end Probability
                      %th.text-end Price History
                  %tbody
                    - market.competitors.each do |competitor|
                      - price = competitor.latest_price
                      - history = competitor.recent_prices
                      %tr
                        %td.fw-semibold= competitor.name
                        %td.text-end
                          - if price&.percentage
                            = "#{price.percentage.to_f.round(1)}%"
                          - else
                            %span.text-muted --
                        %td.text-end
                          - if history.any?
                            .d-flex.flex-wrap.justify-content-end.gap-2
                              - history.first(3).each do |historic_price|
                                %span.badge.bg-light.text-dark
                                  = "#{historic_price.percentage.to_f.round(1)}%"
                                  %small.text-muted.ms-1= "#{time_ago_in_words(historic_price.captured_at)} ago"
                          - else
                            %span.text-muted No prices yet
  - else
    .alert.alert-info No markets have been captured for this event yet.

  %details.mt-5
    %summary.text-muted.small View Raw Data
    %pre.bg-light.p-3.rounded
      %code= JSON.pretty_generate(@event.predictions)