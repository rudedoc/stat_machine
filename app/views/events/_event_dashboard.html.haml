%section.page-section.event-dashboard.pt-0
  - if pred.present?
    -# --- SECTION 1: PROBABILITY & COMPARISON ---
    .row.mb-4
      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small AI Win Probability
          .card-body
            - perc_values = perc || {}
            - home_pct = perc_values['home'] || '0%'
            - draw_pct = perc_values['draw'] || '0%'
            - away_pct = perc_values['away'] || '0%'
            .d-flex.justify-content-between.mb-1.small
              %span= home['name']
              %span= home_pct
            .progress.mb-3{ style: "height: 12px; border-radius: 10px;" }
              .progress-bar.bg-success{ style: "width: #{home_pct}" }
              .progress-bar.bg-secondary{ style: "width: #{draw_pct}" }
              .progress-bar.bg-info{ style: "width: #{away_pct}" }
            .d-flex.justify-content-between.small.text-muted
              %span Draw: #{draw_pct}
              %span= "#{away['name']}: #{away_pct}"

      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small Statistical Advantage
          .card-body.py-2
            - ['att', 'def', 'poisson_distribution', 'h2h'].each do |attr|
              .mb-2
                .d-flex.justify-content-between.very-small.text-uppercase.fw-bold{ style: "font-size: 0.65rem;" }
                  %span= attr.humanize
                .progress{ style: "height: 6px; background-color: #f0f0f0;" }
                  .progress-bar.bg-primary{ style: "width: #{comp.dig(attr, 'home')}" }
                  .progress-bar.bg-info.opacity-50{ style: "width: #{comp.dig(attr, 'away')}" }

      .col-md-4
        .card.h-100.shadow-sm
          .card-header.bg-light.fw-bold.small Head to Head History
          .card-body.p-0
            %ul.list-group.list-group-flush.small
              - pred['h2h'].first(5).each do |game|
                %li.list-group-item.py-1.d-flex.justify-content-between
                  %span.text-muted= game.dig('fixture', 'date').to_date.strftime('%b %y')
                  %span.fw-bold
                    = "#{game.dig('goals', 'home')} - #{game.dig('goals', 'away')}"
                  %span.text-muted.very-small= game.dig('league', 'name')

    -# --- SECTION 2: TEAM FORM MOMENTUM ---
    .row.mb-4
      - [home, away].each_with_index do |team, idx|
        .col-md-6
          .card.shadow-sm
            .card-header.bg-white.d-flex.justify-content-between.align-items-center
              %div
                %img.me-2{ src: team['logo'], width: '20' }
                %strong= team['name']
              .small
                %span.text-muted Last 5:
                - team.dig('league', 'form').to_s.last(5).chars.each do |c|
                  - color = c == 'W' ? 'text-success' : (c == 'L' ? 'text-danger' : 'text-warning')
                  %span{ class: "fw-bold #{color}" }= c
            .card-body.py-2
              .row.text-center
                .col-4
                  .small.text-muted Attacking
                  .h5.mb-0= team.dig('last_5', 'att')
                .col-4.border-start.border-end
                  .small.text-muted Defensive
                  .h5.mb-0= team.dig('last_5', 'def')
                .col-4
                  .small.text-muted Form
                  .h5.mb-0= team.dig('last_5', 'form')

    -# --- SECTION 3: GOAL TIMING & DISCIPLINE ---
    .row.mb-4
      .col-md-8
        .card.shadow-sm
          .card-header.bg-light.fw-bold.small Scoring Patterns (Goals For %)
          .card-body
            .table-responsive
              %table.table.table-borderless.table-sm.mb-0.text-center{ style: "font-size: 0.75rem;" }
                %thead.text-muted.text-uppercase
                  %tr
                    %th Team
                    - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                      %th= min
                %tbody
                  - [home, away].each do |team|
                    %tr
                      %td.text-start.fw-bold= team['name']
                      - ["0-15", "16-30", "31-45", "46-60", "61-75", "76-90"].each do |min|
                        - val = team.dig('league', 'goals', 'for', 'minute', min, 'percentage')
                        %td
                          .p-1.rounded{ class: val.to_f > 25 ? 'bg-success text-white' : 'bg-light' }
                            = val || '0%'
      .col-md-4
        .card.shadow-sm
          .card-header.bg-light.fw-bold.small Tactical & Discipline
          .card-body.py-2
            .d-flex.justify-content-between.small.mb-2
              %span.text-muted Preferred Setup:
              %span.fw-bold= "#{home.dig('league', 'lineups', 0, 'formation')} vs #{away.dig('league', 'lineups', 0, 'formation')}"
            .d-flex.justify-content-between.small.mb-2
              %span.text-muted Clean Sheets:
              %span.fw-bold= "#{home.dig('league', 'clean_sheet', 'total')} - #{away.dig('league', 'clean_sheet', 'total')}"
            %hr.my-2
            .very-small.text-uppercase.text-muted.mb-1 Most Dangerous Discipline Period
            - [home, away].each do |team|
              - dangerous_card_period = team.dig('league', 'cards', 'yellow').max_by { |k, v| v['percentage'].to_f }
              .d-flex.justify-content-between.very-small.mb-1
                %span= team['name']
                %span.text-danger= "#{dangerous_card_period&.first} min (#{dangerous_card_period&.last&.dig('percentage')})"
  - else
    .empty-state.mb-4
      %p.mb-2.text-muted AI predictions are syncing for this event.
      %p.text-muted.mb-0 Check back shortly for win probabilities, team form, and matchup insights.
